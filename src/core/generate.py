import os
import sys
import numpy as np
import pickle
import argparse

# æ·»åŠ é¡¹ç›®æ ¹ç›®å½•åˆ°Pythonè·¯å¾„
project_root = os.path.abspath(os.path.join(os.path.dirname(__file__), '..', '..'))
sys.path.insert(0, project_root)

from src.core.model import HoyoMusicGenerator
from src.tools.abc_to_midi import ABCToMIDIConverter
from src.tools.abc_cleaner import fix_abc_structure

def save_abc_to_file(abc_text, filename):
    """ä¿å­˜ABCæ–‡æœ¬åˆ°æ–‡ä»¶"""
    with open(filename, 'w', encoding='utf-8') as f:
        f.write(abc_text)
    print(f"ğŸ“ ABCéŸ³ä¹å·²ä¿å­˜åˆ°: {filename}")

def clean_generated_abc(text, title="Generated Music"):
    """æ¸…ç†ç”Ÿæˆçš„ABCæ–‡æœ¬ï¼Œä½¿ç”¨ä¸“ä¸šçš„ABCæ¸…ç†å™¨"""
    return fix_abc_structure(text, title)

def main():
    parser = argparse.ArgumentParser(description='ç”ŸæˆHoyoMusicé£æ ¼çš„ABCè®°è°±å’ŒMIDI')
    parser.add_argument('--length', type=int, default=800, help='ç”ŸæˆéŸ³ä¹çš„é•¿åº¦')
    parser.add_argument('--temperature', type=float, default=0.8, help='ç”Ÿæˆçš„éšæœºæ€§(0.1-2.0)')
    parser.add_argument('--region', type=str, default='Mondstadt', 
                       choices=['Mondstadt', 'Liyue', 'Inazuma', 'Sumeru', 'Fontaine'],
                       help='åŸç¥åœ°åŒºé£æ ¼')
    parser.add_argument('--output-name', type=str, default='hoyomusic_generated',
                       help='è¾“å‡ºæ–‡ä»¶åï¼ˆä¸å«æ‰©å±•åï¼‰')
    parser.add_argument('--no-midi', action='store_true', help='ä¸ç”ŸæˆMIDIæ–‡ä»¶')
    parser.add_argument('--tune-index', type=int, default=0, help='è½¬æ¢MIDIæ—¶é€‰æ‹©çš„æ›²å­ç´¢å¼•')
    
    args = parser.parse_args()
    
    print("ğŸµ HoyoMusicé£æ ¼ç”Ÿæˆå™¨")
    print(f"ğŸŒ ç”Ÿæˆ {args.region} é£æ ¼çš„éŸ³ä¹...")
    
    # 1. åŠ è½½å­—ç¬¦æ˜ å°„
    print("ğŸ“‚ åŠ è½½æ¨¡å‹é…ç½®...")
    try:
        with open('models/hoyomusic_mappings.pkl', 'rb') as f:
            mappings = pickle.load(f)
        
        char_to_int = mappings['char_to_int']
        int_to_char = mappings['int_to_char']
        vocab_size = mappings['vocab_size']
        seq_length = mappings['seq_length']
        
        print(f"âœ… è¯æ±‡è¡¨å¤§å°: {vocab_size}, åºåˆ—é•¿åº¦: {seq_length}")
        
    except FileNotFoundError:
        print("âŒ é”™è¯¯: æœªæ‰¾åˆ°å­—ç¬¦æ˜ å°„æ–‡ä»¶ models/hoyomusic_mappings.pkl")
        print("è¯·å…ˆè¿è¡Œ python train.py --use-hoyomusic è®­ç»ƒæ¨¡å‹")
        return
    
    # 2. åŠ è½½æ¨¡å‹
    print("ğŸ¤– åŠ è½½è®­ç»ƒå¥½çš„æ¨¡å‹...")
    try:
        generator = HoyoMusicGenerator(vocab_size, seq_length)
        generator.load_model('models/hoyomusic_generator.pth')
    except FileNotFoundError:
        print("âŒ é”™è¯¯: æœªæ‰¾åˆ°æ¨¡å‹æ–‡ä»¶ models/hoyomusic_generator.pth")
        print("è¯·å…ˆè¿è¡Œ python train.py --use-hoyomusic è®­ç»ƒæ¨¡å‹")
        return
    
    # 3. ç”ŸæˆéŸ³ä¹
    print(f"ğŸ¼ ç”ŸæˆéŸ³ä¹ (é•¿åº¦: {args.length}, æ¸©åº¦: {args.temperature}, é£æ ¼: {args.region})...")
    
    try:
        generated_text = generator.generate_hoyomusic_style(
            region=args.region,
            length=args.length,
            temperature=args.temperature,
            char_to_int=char_to_int,
            int_to_char=int_to_char
        )
    except Exception as e:
        print(f"âŒ ç”ŸæˆéŸ³ä¹æ—¶å‡ºé”™: {e}")
        # ä½¿ç”¨é€šç”¨ç”Ÿæˆæ–¹æ³•ä½œä¸ºå¤‡é€‰
        print("ğŸ”„ å°è¯•ä½¿ç”¨é€šç”¨ç”Ÿæˆæ–¹æ³•...")
        seed = f"X:1\nT:{args.region} Song\nC:Generated by HoyoMusic AI\nM:4/4\nL:1/8\nK:C major\n"
        generated_text = generator.generate_music(
            seed_text=seed,
            char_to_int=char_to_int,
            int_to_char=int_to_char,
            length=args.length,
            temperature=args.temperature
        )
    
    # 4. æ¸…ç†å’Œä¿å­˜ABCæ–‡ä»¶
    print("ğŸ”§ åå¤„ç†ABCæ ¼å¼...")
    cleaned_text = clean_generated_abc(generated_text, f"{args.region} Style Music")
    
    # ç¡®ä¿è¾“å‡ºç›®å½•å­˜åœ¨
    os.makedirs('generated_music', exist_ok=True)
    
    abc_filename = f'generated_music/{args.output_name}.abc'
    save_abc_to_file(cleaned_text, abc_filename)
    
    # 5. è½¬æ¢ä¸ºMIDI
    if not args.no_midi:
        print("ğŸ¹ è½¬æ¢ä¸ºMIDIæ ¼å¼...")
        midi_filename = f'generated_music/{args.output_name}.mid'
        
        converter = ABCToMIDIConverter()
        success = converter.convert_abc_to_midi(
            cleaned_text, 
            midi_filename, 
            tune_index=args.tune_index
        )
        
        if success:
            print(f"ğŸ¼ MIDIæ–‡ä»¶å·²ä¿å­˜åˆ°: {midi_filename}")
        else:
            print("âš ï¸  MIDIè½¬æ¢å¤±è´¥ï¼Œä½†ABCæ–‡ä»¶å·²ç”Ÿæˆ")
    
    # 6. æ˜¾ç¤ºç”Ÿæˆç»“æœ
    print("\n" + "="*60)
    print(f"ğŸµ ç”Ÿæˆçš„{args.region}é£æ ¼ABCéŸ³ä¹:")
    print("="*60)
    
    # æ˜¾ç¤ºå‰500ä¸ªå­—ç¬¦
    display_text = cleaned_text[:500] + "..." if len(cleaned_text) > 500 else cleaned_text
    print(display_text)
    
    print("="*60)
    
    print(f"\nğŸ“ æ–‡ä»¶å·²ä¿å­˜:")
    print(f"  - ABCè®°è°±: {abc_filename}")
    if not args.no_midi:
        print(f"  - MIDIæ–‡ä»¶: generated_music/{args.output_name}.mid")
    
    print(f"\nğŸ§ æ’­æ”¾å»ºè®®:")
    print(f"  - åœ¨çº¿æ’­æ”¾ABC: https://abcjs.net/abcjs-editor.html")
    print(f"  - MIDIæ’­æ”¾å™¨: ä»»ä½•æ”¯æŒMIDIçš„éŸ³ä¹è½¯ä»¶")
    print(f"  - å¯¼å…¥MuseScore: è¿›ä¸€æ­¥ç¼–è¾‘å’Œç¾åŒ–")
    
    print(f"\nâœ¨ æç¤º:")
    print(f"  - è°ƒæ•´ --temperature å‚æ•°æ¥æ”¹å˜åˆ›æ„ç¨‹åº¦")
    print(f"  - å°è¯•ä¸åŒçš„ --region æ¥ä½“éªŒå„åœ°åŒºé£æ ¼")
    print(f"  - ä½¿ç”¨ --length æ§åˆ¶ç”Ÿæˆçš„éŸ³ä¹é•¿åº¦")

if __name__ == "__main__":
    main()